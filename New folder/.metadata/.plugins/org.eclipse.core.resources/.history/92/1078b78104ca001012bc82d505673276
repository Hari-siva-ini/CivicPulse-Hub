package com.example.backend.Controller;

import java.io.IOException;
import java.sql.Date;
import java.util.Base64;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.example.backend.Repository.complaintRepo;
import com.example.backend.models.complaintEntity;

@RestController
@RequestMapping("/api/complaints")
@CrossOrigin(origins = "http://localhost:3000")
public class complaintController {
    @Autowired
    private complaintRepo complaintRepo;
    
    @GetMapping("/user/{email}")
    public ResponseEntity<?> getComplaintsByEmail(@PathVariable String email) {
        List<complaintEntity> complaints = complaintRepo.findByEmail(email);
        if (complaints.isEmpty()) { 
            return ResponseEntity.status(404).body("No complaints found for " + email);
        }
        return ResponseEntity.ok(complaints);
    }
    @GetMapping("user/off/{officer}")
    public ResponseEntity<?> getComplaintsByOfficer(@PathVariable String officer) {
        List<complaintEntity> complaints = complaintRepo.findByOfficer(officer);
        if (complaints.isEmpty()) { 
            return ResponseEntity.status(404).body("No complaints found for " + officer);
        }
        return ResponseEntity.ok(complaints);
    }
    @GetMapping("/all")
    public List<complaintEntity> getAllComplaints() {
        return complaintRepo.findAll();
    }
    @PostMapping("/add")
    public String addComplaint(
            @RequestParam("title") String title,
            @RequestParam("description") String description,
            @RequestParam("category") String category,
            @RequestParam("location") String location,
            @RequestParam("email") String email,
            @RequestParam("submitDate") Date date,
            @RequestParam(value = "image", required = false) MultipartFile image
    ) {
        try {
            complaintEntity complaint = new complaintEntity();
            complaint.setTitle(title);
            complaint.setDescription(description);
            complaint.setCategory(category);
            complaint.setLocation(location);
            complaint.setEmail(email);
            complaint.setSubmitDate(date);
            complaint.setStatus("Pending");
            if (image != null && !image.isEmpty()) {
                String base64Image = Base64.getEncoder().encodeToString(image.getBytes());
                complaint.setImageUrl(base64Image);
            }

            complaintRepo.save(complaint);
            return "✅ Complaint submitted successfully!";

        } catch (IOException e) {
            return "❌ Error uploading image: " + e.getMessage();
        }
    }
    @PutMapping("/{id}/status")
    public ResponseEntity<?> assignWork(@PathVariable Long id,@RequestBody complaintEntity com)
    {
    	complaintEntity exist = (complaintEntity) complaintRepo.findById(id).orElse(null);
    	if(exist==null) {
    		return ResponseEntity.status(404).body("Complaint not found with ID: " + id);
    	}
    	exist.setStatus("In Progress");
    	exist.setDeadline(com.getDeadline());
    	exist.setOfficer(com.getOfficer());
    	complaintRepo.save(exist);
    	return ResponseEntity.ok("{Changed}");
    }
    @PostMapping("/{id}/status/resolved")
    public ResponseEntity<?> resolvedWork(
            @PathVariable Long id,
            @RequestParam(value = "proof", required = false) MultipartFile image) throws IOException {

        complaintEntity exist = (complaintEntity) complaintRepo.findById(id).orElse(null);

        if (exist == null) {
            return ResponseEntity.status(400).body("No complaint found");
        }

        exist.setStatus("Resolved");
//        System.out.println(image);
        // Save proof image separately
        if (image != null && !image.isEmpty()) {
//        	System.out.println("JJ");
            String base64Image = Base64.getEncoder().encodeToString(image.getBytes());
            exist.setSubmitProff(base64Image);
        }

        complaintRepo.save(exist);
        return ResponseEntity.ok("Complaint marked as resolved with proof uploaded");
    }
    @PutMapping("{id}/resubmit")
    public Boolean reSubmit(@PathVariable Long id)
    {
//    	System.out.println("Hellow");
    	complaintEntity exist = (complaintEntity) complaintRepo.findById(id).orElse(null);
    	if(exist==null) {
    		return false;
    	}
    	exist.setStatus("In Progress");
    	System.out.println(exist.getStatus());
    	complaintRepo.save(exist);
    	return true;
    }
    @PostMapping("/{id}/feedback")
    public ResponseEntity<?> feedback(@PathVariable Long id)
    {
    	System.out.println("Hellow");
//    	complaintEntity exist = (complaintEntity) complaintRepo.findById(id).orElse(null);
//    	if(exist==null)
//    	{
//    		return ResponseEntity.status(400).body("No complains");
//    	}
//    	exist.setRate(rate);
//    	complaintRepo.save(exist);
    	return ResponseEntity.ok("{Changed}");
    }
    
    @DeleteMapping("/{id}/cancel")
    public ResponseEntity<?> cancelGreevence(@PathVariable Long id)
    {
    	complaintEntity exist = (complaintEntity) complaintRepo.findById(id).orElse(null);
    	if(exist==null)
    	{
    		return ResponseEntity.status(400).body("No complains");
    	}
    	complaintRepo.delete(exist);
    	return ResponseEntity.ok("Cancelled");
    }
}
